name: Run Integration Tests (Ubuntu built-in Postgres)

on:
  # Auto-run after your Windows CI completes successfully
  workflow_run:
    workflows: ["HundredX Continuous Integration"]
    types: [completed]
  # Manual runs too
  workflow_dispatch:

jobs:
  integration-tests:
    # Proceed on manual dispatch OR successful CI completion
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-24.04

    env:
      # App/test connection string (DB name = hundredx)
      ConnectionStrings__Default: Host=localhost;Port=5432;Database=hundredx;Username=postgres;Password=postgres;Pooling=true
      # psql convenience
      PGUSER: postgres
      PGPASSWORD: postgres
      PGDATABASE: hundredx
      PGPORT: 5432

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      # (Optional but helpful) list artifacts from the triggering CI run
      - name: List artifacts in triggering run
        if: github.event_name == 'workflow_run'
        uses: actions/github-script@v7
        with:
          script: |
            const runId = context.payload.workflow_run.id;
            const { data } = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId,
              per_page: 100,
            });
            core.info(`Artifacts for run ${runId}: ${data.artifacts.map(a => a.name).join(', ') || '(none)'}`);

      # Download all artifacts from the CI run (kept in separate folders)
      - name: Download artifacts from CI run
        if: github.event_name == 'workflow_run'
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ github.event.workflow_run.id }}
          path: artifacts
          merge-multiple: false

      # Prefer artifact named "SQL"; fall back to repo SQLScripts if present
      - name: Locate SQL scripts
        run: |
          set -e
          if [ -d "artifacts/SQL" ]; then
            mkdir -p SQLScripts
            cp -R artifacts/SQL/. SQLScripts/
            echo "Using SQLScripts from artifact 'SQL'."
          elif [ -d "SQLScripts" ]; then
            echo "No 'SQL' artifact found; using SQLScripts from repo."
          else
            echo "No SQLScripts found in artifacts or repo; continuing without seeding."
          fi

      - name: Install psql client
        run: |
          sudo apt-get update -y
          sudo apt-get install -y postgresql-client

      - name: Start built-in PostgreSQL and prepare DB
        run: |
          # Start preinstalled Postgres service on Ubuntu runners
          sudo systemctl start postgresql

          # Wait for server readiness
          for i in $(seq 1 60); do
            pg_isready -h localhost -p 5432 && break
            sleep 1
          done

          # Ensure 'postgres' user has a password for TCP auth
          sudo -u postgres psql -c "ALTER USER postgres WITH PASSWORD 'postgres';"

          # Create DB 'hundredx' if not exists
          sudo -u postgres psql -d postgres -tc "SELECT 1 FROM pg_database WHERE datname='hundredx';" | grep -q 1 \
            || sudo -u postgres createdb hundredx

      - name: Seed database (if init.sql exists)
        run: |
          if [ -f "SQLScripts/init.sql" ]; then
            PGPASSWORD="$PGPASSWORD" psql -h localhost -U "$PGUSER" -d "$PGDATABASE" -f SQLScripts/init.sql
          else
            echo "No SQLScripts/init.sql found; skipping seed."
          fi

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore
        run: dotnet restore

      - name: Build (Release)
        run: dotnet build HundredX.sln -c Release --no-restore

      # Run tests by pointing at the .csproj via working-directory
      - name: Run Integration Tests
        working-directory: ./HundredX.API.IntegrationTests
        run: |
          dotnet test HundredX.API.IntegrationTests.csproj \
            --no-build \
            --logger "trx;LogFileName=TestResults.trx" \
            --results-directory bin/TestResults

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: TestResults
          path: HundredX.API.IntegrationTests/bin/TestResults
