name: Run Integration Tests (Ubuntu built-in Postgres)

on:
  workflow_run:
    workflows: ["HundredX Continuous Integration"]
    types: [completed]
  workflow_dispatch:

jobs:
  integration-tests:
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-24.04

    env:
      ASPNETCORE_CONTENTROOT: ${{ github.workspace }}/HundredX.API
      ConnectionStrings__Default: Host=localhost;Port=5432;Database=hundredx;Username=postgres;Password=postgres;Pooling=true
      PGUSER: postgres
      PGPASSWORD: postgres
      PGDATABASE: hundredx
      PGPORT: 5432

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Ensure psql client exists
        run: |
          if ! command -v psql >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y postgresql-client
          fi

      - name: Start built-in PostgreSQL and prepare DB
        run: |
          sudo systemctl start postgresql
          for i in $(seq 1 60); do
            pg_isready -h localhost -p 5432 && break
            sleep 1
          done
          sudo -u postgres psql -c "ALTER USER postgres WITH PASSWORD 'postgres';"
          sudo -u postgres psql -d postgres -tc "SELECT 1 FROM pg_database WHERE datname='hundredx';" | grep -q 1 \
            || sudo -u postgres createdb hundredx

      - name: Seed database from repo (if any .sql files exist)
        run: |
          if [ -d "SQLScripts" ]; then
            shopt -s nullglob
            for f in SQLScripts/*.sql; do
              echo "Seeding: $f"
              PGPASSWORD="$PGPASSWORD" psql -h localhost -U "$PGUSER" -d "$PGDATABASE" -f "$f"
            done
          else
            echo "No SQLScripts directory found; skipping seed."
          fi

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore
        run: dotnet restore

      - name: Build (Release)
        run: dotnet build HundredX.sln -c Release --no-restore

      - name: Verify content root
        run: |
          echo "ASPNETCORE_CONTENTROOT=$ASPNETCORE_CONTENTROOT"
          test -d "$ASPNETCORE_CONTENTROOT" || { echo "Content root not found"; ls -la "${{ github.workspace }}"; exit 1; }

      # Run tests 
      - name: Run Integration Tests (HTML logger)
        working-directory: ./HundredX.API.IntegrationTests
        run: |
          dotnet test HundredX.API.IntegrationTests.csproj \
            -c Release \
            --no-build \
            --logger "html;LogFileName=TestResults.html" \
            --results-directory bin/TestResults

      # Upload the HTML report
      - name: Upload HTML Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: TestResultsHTML
          path: |
            HundredX.API.IntegrationTests/bin/TestResults/**/*.html
